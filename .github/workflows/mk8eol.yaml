name: Sync Confluence to GitHub

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml
      
      - name: Debug - Check if secrets are available
        run: |
          echo "Checking secrets (values hidden)..."
          if [ -z "${{ secrets.CONFLUENCE_URL }}" ]; then
            echo "❌ CONFLUENCE_URL is not set"
          else
            echo "✓ CONFLUENCE_URL is set"
          fi
          
          if [ -z "${{ secrets.CONFLUENCE_EMAIL }}" ]; then
            echo "❌ CONFLUENCE_EMAIL is not set"
          else
            echo "✓ CONFLUENCE_EMAIL is set"
          fi
          
          if [ -z "${{ secrets.CONFLUENCE_API_TOKEN }}" ]; then
            echo "❌ CONFLUENCE_API_TOKEN is not set"
          else
            echo "✓ CONFLUENCE_API_TOKEN is set"
          fi
          
          if [ -z "${{ secrets.PAGE_ID }}" ]; then
            echo "❌ PAGE_ID is not set"
          else
            echo "✓ PAGE_ID is set"
          fi
      
      - name: Fetch and update from Confluence
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          PAGE_ID: ${{ secrets.PAGE_ID }}
          OUTPUT_FILE: 'abc.md'
        run: |
          python sync_script.py
      
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add abc.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-sync from Confluence [skip ci]"
            git push
          fi
